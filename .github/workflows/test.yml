name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

    - name: List available iOS runtimes
      run: xcrun simctl list runtimes

    - name: Create and boot iOS Simulator
      run: |
        # Get the latest iOS runtime available
        RUNTIME=$(xcrun simctl list runtimes | grep "iOS" | tail -1 | grep -oE "com\.apple\.CoreSimulator\.SimRuntime\.iOS-[0-9-]+")
        echo "Using runtime: $RUNTIME"

        # Create simulator
        SIMULATOR_ID=$(xcrun simctl create test-device com.apple.CoreSimulator.SimDeviceType.iPhone-15 "$RUNTIME" 2>&1 | tail -1)
        echo "Created simulator: $SIMULATOR_ID"

        # Boot it
        xcrun simctl boot "$SIMULATOR_ID"

        # Wait for it to boot
        sleep 5

        echo "SIMULATOR_ID=$SIMULATOR_ID" >> $GITHUB_ENV

    - name: Run tests with iOS Simulator
      run: |
        xcodebuild test \
          -scheme MediaBridge \
          -destination "id=${{ env.SIMULATOR_ID }}" \
          -derivedDataPath .build \
          -enableCodeCoverage YES \
          -verbose

    - name: Extract and report coverage
      id: coverage
      continue-on-error: true
      run: |
        # Find coverage data in test results
        if [ -d ".build/Logs/Test" ]; then
          # Try to extract from test logs
          COVERAGE=$(grep -oE 'Code Coverage:[[:space:]]*[0-9]+\.?[0-9]*%' .build/Logs/Test/*.txt 2>/dev/null | grep -oE '[0-9]+\.?[0-9]*' | head -1)
        fi

        # Fallback to 0 if not found
        COVERAGE=${COVERAGE:-0}
        echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
        echo "Coverage percentage: $COVERAGE%"
