name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

    - name: List available iOS runtimes
      run: xcrun simctl list runtimes

    - name: Create and boot iOS Simulator
      run: |
        # Get the latest iOS runtime available
        RUNTIME=$(xcrun simctl list runtimes | grep "iOS" | tail -1 | grep -oE "com\.apple\.CoreSimulator\.SimRuntime\.iOS-[0-9-]+")
        echo "Using runtime: $RUNTIME"

        # Create simulator
        SIMULATOR_ID=$(xcrun simctl create test-device com.apple.CoreSimulator.SimDeviceType.iPhone-15 "$RUNTIME" 2>&1 | tail -1)
        echo "Created simulator: $SIMULATOR_ID"

        # Boot it
        xcrun simctl boot "$SIMULATOR_ID"

        # Wait for it to boot
        sleep 5

        echo "SIMULATOR_ID=$SIMULATOR_ID" >> $GITHUB_ENV

    - name: Run tests with iOS Simulator
      run: |
        xcodebuild test \
          -scheme MediaBridge \
          -destination "id=${{ env.SIMULATOR_ID }}" \
          -derivedDataPath .build \
          -enableCodeCoverage YES \
          -verbose

    - name: Extract and report coverage
      id: coverage
      continue-on-error: true
      run: |
        # Find the xcresult bundle
        XCRESULT=$(find .build/Logs/Test -name "*.xcresult" -type d | head -1)

        if [ -n "$XCRESULT" ]; then
          echo "Found xcresult: $XCRESULT"

          # List coverage reports available
          echo "Available coverage data:"
          find "$XCRESULT" -name "*.xccovreport" -o -name "coverage.json" 2>/dev/null

          # Try to extract coverage from the xcresult package
          # Method 1: Look for coverage.json directly
          COVERAGE_JSON=$(find "$XCRESULT" -name "coverage.json" 2>/dev/null | head -1)

          if [ -n "$COVERAGE_JSON" ]; then
            COVERAGE=$(python3 -c "import json; data=json.load(open('$COVERAGE_JSON')); print(round(data.get('lineCoverage', {}).get('percentage', 0), 2))" 2>/dev/null || echo "0")
          else
            # Method 2: Try xcrun xccov on the coverage directory
            COVERAGE_DIR=$(find "$XCRESULT" -type d -name "*.xccovreport" 2>/dev/null | head -1)
            if [ -n "$COVERAGE_DIR" ]; then
              COVERAGE=$(xcrun xccov view --json "$COVERAGE_DIR" 2>/dev/null | python3 -c "import sys, json; data=json.load(sys.stdin); files=data.get('files', []); total=sum(f.get('lineCoverage', 0) for f in files); count=len(files); print(round(total/count*100, 2) if count > 0 else 0)" 2>/dev/null || echo "0")
            else
              COVERAGE="0"
            fi
          fi
        else
          echo "No xcresult found"
          COVERAGE="0"
        fi

        # Fallback to 0 if empty
        COVERAGE=${COVERAGE:-0}
        echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
        echo "Coverage percentage: $COVERAGE%"
