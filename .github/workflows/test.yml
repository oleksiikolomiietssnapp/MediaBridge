name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

    - name: Create iOS Simulator
      run: |
        xcrun simctl create test-simulator com.apple.CoreSimulator.SimDeviceType.iPhone-15 com.apple.CoreSimulator.SimRuntime.iOS-18-1 || true
        SIMULATOR_ID=$(xcrun simctl list devices iPhone | grep "iPhone 15" | head -1 | sed 's/.*(\([0-9A-F\-]*\)).*/\1/')
        echo "SIMULATOR_ID=$SIMULATOR_ID" >> $GITHUB_ENV

    - name: Boot Simulator
      run: xcrun simctl boot $SIMULATOR_ID || true

    - name: Run tests with iOS Simulator
      run: |
        xcodebuild test \
          -scheme MediaBridge \
          -destination "generic/platform=iOS Simulator,name=iPhone 15" \
          -derivedDataPath .build \
          -verbose || swift test
